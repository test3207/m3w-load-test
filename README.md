# M3W Load Test

Load testing suite for [M3W](https://github.com/test3207/m3w) - k6 scripts for capacity and performance testing.

## Overview

This repository contains load testing infrastructure to:

- Determine maximum concurrent users for given resources
- Identify performance bottlenecks
- Establish baseline metrics for optimization

## Structure

```Text
m3w-load-test/
├── docker-compose.yml       # Complete test environment (M3W + PostgreSQL + MinIO)
├── scripts/
│   ├── run-test.cjs         # Full test runner (start → seed → k6 → cleanup → stop)
│   ├── seed.cjs             # Test data preparation
│   └── cleanup.cjs          # Cleanup script
├── k6/
│   ├── config.js            # Shared configuration
│   └── capacity.js          # User capacity test
├── results/                 # Test reports (gitignored)
└── README.md
```

## Resource Limits

Test environment simulates a typical VPS (4 CPU / 4GB RAM):

| Service | CPU | Memory |
|---------|-----|--------|
| M3W | 2 cores | 2GB |
| PostgreSQL | 1 core | 1GB |
| MinIO | 1 core | 1GB |

## Test Design

### User Behavior Model

| Phase | Weight | Actions |
|-------|--------|---------|
| Startup | 5% | Auth, list libraries/playlists |
| Listening | 85% | Stream audio, update progress every 30s |
| Managing | 10% | Create/delete playlists |

### Load Stages

| Stage | VUs | Duration |
|-------|-----|----------|
| Warm-up | 1 | 1 min |
| Baseline | 10 | 3 min |
| Load | 25 | 3 min |
| Stress | 50 | 3 min |
| Peak | 100 | 3 min |

### Success Criteria

- API response p95 < 500ms
- Audio stream TTFB < 200ms
- Error rate < 1%

## Prerequisites

- [k6](https://k6.io/docs/get-started/installation/) installed
- Docker & Docker Compose
- Node.js 20+ (for seed scripts)

## Quick Start

```bash
# Clone and install
git clone https://github.com/test3207/m3w-load-test.git
cd m3w-load-test
npm install

# Run full test (start containers → seed → k6 → cleanup → stop)
npm run test:full

# Or with podman
npm run test:full -- --podman
```

That's it! One command does everything.

### Options

```bash
npm run test:full              # Full test cycle with docker (auto-detected)
npm run test:full -- --podman  # Force use podman
npm run test:full -- --docker  # Force use docker
npm run test:full -- --keep    # Keep containers running after test
npm run test:full -- --skip-k6 # Skip k6 test (just verify seed/cleanup)
npm run test:quick             # Quick test without k6 (verify setup only)
```

### Manual Steps (if needed)

```bash
# Start containers manually
npm run docker:up    # or: npm run podman:up

# Seed test data
npm run seed

# Run k6 test
npm run test:capacity

# Cleanup
npm run cleanup       # Remove test playlists only
npm run cleanup:full  # Remove everything + test user

# Stop containers
npm run docker:down   # or: npm run podman:down
```

### Testing Against Existing M3W Instance

```bash
# Point to your instance (must share same JWT_SECRET)
export BASE_URL=http://your-m3w-instance:4000
export DATABASE_URL=postgresql://user:pass@host:5432/db
export JWT_SECRET=your-jwt-secret

npm run seed
npm run test:capacity
```

## Seeding Test Data

The seed script (`scripts/seed.cjs`) is **fully automatic**:

1. Connects to PostgreSQL and creates test user
2. Generates valid JWT token (no manual steps!)
3. Verifies service health and authentication
4. Creates "Load Test Library" (or uses existing)
5. Uploads audio files from `fixtures/` directory (if present)
6. Creates "Load Test Playlist" with sample songs
7. Writes `.env.test` with all required environment variables

### Adding Test Audio Files

```bash
# Add audio files to fixtures/ directory
cp /path/to/sample.mp3 fixtures/
cp /path/to/another.flac fixtures/

# Re-run seed to upload
node scripts/seed.cjs
```

## Configuration

Environment variables for k6 scripts:

| Variable | Default | Description |
|----------|---------|-------------|
| `BASE_URL` | `http://localhost:4000` | M3W API base URL |
| `DATABASE_URL` | `postgresql://m3w:m3w@localhost:5432/m3w` | PostgreSQL connection |
| `JWT_SECRET` | `load-test-secret-key` | JWT signing secret |
| `TEST_USER_TOKEN` | (auto-generated) | Auth token for API requests |
| `TEST_LIBRARY_ID` | (auto-generated) | Library ID for song operations |
| `TEST_SONG_ID` | (auto-generated) | Song ID for streaming tests |

All `TEST_*` variables are auto-generated by `npm run seed` into `.env.test`.

## Related

- [M3W Main Repository](https://github.com/test3207/m3w)
- Parent Issue: [test3207/m3w#180](https://github.com/test3207/m3w/issues/180)
