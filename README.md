# M3W Load Test

Load testing suite for [M3W](https://github.com/test3207/m3w) - k6 scripts for capacity and performance testing.

## Overview

This repository contains load testing infrastructure to:

- Determine maximum concurrent users for given resources
- Identify performance bottlenecks
- Establish baseline metrics for optimization

## Structure

```Text
m3w-load-test/
├── docker-compose.yml       # Complete test environment (M3W + PostgreSQL + MinIO)
├── scripts/
│   ├── seed.cjs             # Test data preparation
│   └── cleanup.cjs          # Cleanup script
├── k6/
│   ├── config.js            # Shared configuration
│   └── capacity.js          # User capacity test
├── results/                 # Test reports (gitignored)
└── README.md
```

## Test Design

### User Behavior Model

| Phase | Weight | Actions |
|-------|--------|---------|
| Startup | 5% | Auth, list libraries/playlists |
| Listening | 85% | Stream audio, update progress every 30s |
| Managing | 10% | Create/delete playlists |

### Load Stages

| Stage | VUs | Duration |
|-------|-----|----------|
| Warm-up | 1 | 1 min |
| Baseline | 10 | 3 min |
| Load | 25 | 3 min |
| Stress | 50 | 3 min |
| Peak | 100 | 3 min |

### Success Criteria

- API response p95 < 500ms
- Audio stream TTFB < 200ms
- Error rate < 1%

## Prerequisites

- [k6](https://k6.io/docs/get-started/installation/) installed
- Docker & Docker Compose
- Node.js 20+ (for seed scripts)

## Quick Start

### Option A: Test against existing M3W instance

```bash
# 1. Get auth token from M3W (browser DevTools > Cookies > access_token)
export TEST_USER_TOKEN=<your-jwt-token>
export BASE_URL=http://localhost:4000

# 2. Seed test data (creates library, uploads fixtures if present)
node scripts/seed.cjs

# 3. Load environment from generated .env.test
source .env.test

# 4. Run capacity test
k6 run k6/capacity.js

# 5. Cleanup test playlists
node scripts/cleanup.cjs
```

### Option B: Spin up isolated test environment

```bash
# 1. Start test environment (M3W + PostgreSQL + MinIO)
docker compose up -d

# 2. Create user and get token (via browser or API)
# ...then follow steps from Option A
```

## Seeding Test Data

The seed script (`scripts/seed.cjs`):

1. Verifies connectivity and authentication
2. Creates "Load Test Library" (or uses existing)
3. Uploads audio files from `fixtures/` directory (if present)
4. Creates "Load Test Playlist" with sample songs
5. Writes `.env.test` with all required environment variables

### Adding Test Audio Files

```bash
# Add audio files to fixtures/ directory
cp /path/to/sample.mp3 fixtures/
cp /path/to/another.flac fixtures/

# Re-run seed to upload
node scripts/seed.cjs
```

## Configuration

Environment variables for k6 scripts:

| Variable | Default | Description |
|----------|---------|-------------|
| `BASE_URL` | `http://localhost:4000` | M3W API base URL |
| `TEST_USER_TOKEN` | - | Auth token for API requests |
| `TEST_LIBRARY_ID` | - | Library ID for song operations |
| `TEST_SONG_ID` | - | Song ID for streaming tests |

All variables are auto-generated by `seed.cjs` into `.env.test`.

## Related

- [M3W Main Repository](https://github.com/test3207/m3w)
- Parent Issue: [test3207/m3w#180](https://github.com/test3207/m3w/issues/180)
