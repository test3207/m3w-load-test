# M3W Load Test

Load testing suite for [M3W](https://github.com/test3207/m3w) - k6 scripts for capacity and performance testing.

## Overview

This repository contains load testing infrastructure to:

- Determine maximum concurrent users for given resources
- Identify performance bottlenecks
- Establish baseline metrics for optimization

## Structure

```Text
m3w-load-test/
├── docker-compose.yml       # Complete test environment (M3W + PostgreSQL + MinIO)
├── scripts/
│   ├── seed.cjs             # Test data preparation
│   └── cleanup.cjs          # Cleanup script
├── k6/
│   ├── config.js            # Shared configuration
│   └── capacity.js          # User capacity test
├── results/                 # Test reports (gitignored)
└── README.md
```

## Test Design

### User Behavior Model

| Phase | Weight | Actions |
|-------|--------|---------|
| Startup | 5% | Auth, list libraries/playlists |
| Listening | 85% | Stream audio, update progress every 30s |
| Managing | 10% | Create/delete playlists |

### Load Stages

| Stage | VUs | Duration |
|-------|-----|----------|
| Warm-up | 1 | 1 min |
| Baseline | 10 | 3 min |
| Load | 25 | 3 min |
| Stress | 50 | 3 min |
| Peak | 100 | 3 min |

### Success Criteria

- API response p95 < 500ms
- Audio stream TTFB < 200ms
- Error rate < 1%

## Prerequisites

- [k6](https://k6.io/docs/get-started/installation/) installed
- Docker & Docker Compose
- Node.js 20+ (for seed scripts)

## Quick Start

```bash
# 1. Clone and install dependencies
git clone https://github.com/test3207/m3w-load-test.git
cd m3w-load-test
npm install

# 2. Start test environment
npm run docker:up

# 3. Seed test data (fully automatic - creates user, generates token, etc.)
npm run seed

# 4. Run capacity test
npm run test:capacity

# 5. Cleanup (optional)
npm run cleanup
```

That's it! No manual token retrieval needed.

### Testing Against Existing M3W Instance

```bash
# Point to your instance (must share same JWT_SECRET)
export BASE_URL=http://your-m3w-instance:4000
export DATABASE_URL=postgresql://user:pass@host:5432/db
export JWT_SECRET=your-jwt-secret

npm run seed
npm run test:capacity
```

## Seeding Test Data

The seed script (`scripts/seed.cjs`) is **fully automatic**:

1. Connects to PostgreSQL and creates test user
2. Generates valid JWT token (no manual steps!)
3. Verifies service health and authentication
4. Creates "Load Test Library" (or uses existing)
5. Uploads audio files from `fixtures/` directory (if present)
6. Creates "Load Test Playlist" with sample songs
7. Writes `.env.test` with all required environment variables

### Adding Test Audio Files

```bash
# Add audio files to fixtures/ directory
cp /path/to/sample.mp3 fixtures/
cp /path/to/another.flac fixtures/

# Re-run seed to upload
node scripts/seed.cjs
```

## Configuration

Environment variables for k6 scripts:

| Variable | Default | Description |
|----------|---------|-------------|
| `BASE_URL` | `http://localhost:4000` | M3W API base URL |
| `DATABASE_URL` | `postgresql://m3w:m3w@localhost:5432/m3w` | PostgreSQL connection |
| `JWT_SECRET` | `load-test-secret-key` | JWT signing secret |
| `TEST_USER_TOKEN` | (auto-generated) | Auth token for API requests |
| `TEST_LIBRARY_ID` | (auto-generated) | Library ID for song operations |
| `TEST_SONG_ID` | (auto-generated) | Song ID for streaming tests |

All `TEST_*` variables are auto-generated by `npm run seed` into `.env.test`.

## Related

- [M3W Main Repository](https://github.com/test3207/m3w)
- Parent Issue: [test3207/m3w#180](https://github.com/test3207/m3w/issues/180)
